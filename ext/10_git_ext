# vim: set ft=sh
# can't remember where I found this..

git config --global alias.ch '!~/.bash/git-checkout.py'


existing-pr() {
  local branch
  if branch="$(git rev-parse --symbolic-full-name @{upstream} 2>/dev/null)"; then
    branch="${branch#refs/remotes/}"
    branch="${branch#*/}"
  else
    branch="$(git rev-parse --symbolic-full-name HEAD)"
    branch="${branch#refs/heads/}"
  fi

  hub api -t graphql -fbranch="$branch" -fquery='
    query($branch: String!) {
      repository(owner: "{owner}", name: "{repo}") {
        pullRequests(headRefName: $branch, states: OPEN, first: 10) {
          edges {
            node {
              url
              repository {
                owner {
                  login
                }
              }
              headRepository {
                owner {
                  login
                }
              }
            }
          }
        }
      }
    }
  ' | group_edges 3 | while read -r url base_owner head_owner; do
    [ "$base_owner" != "$head_owner" ] || printf '%s\n' "$url"
  done | head -1
}

group_edges() {
  grep -F '[' | cut -f2 | xargs -L${1?}
}

alias gco='git co'
alias gpush='git push origin -u HEAD'
alias gpull='git pull'
alias gf='git fetch'

git_completion_path="/Library/Developer/CommandLineTools/usr/share/git-core/git-completion.bash"
[ -f "$git_completion_path" ] && source "$git_completion_path"


